{{- $p := .Page | default . -}}
{{- $src := .Src -}}

{{- /* Early return for external/static images */ -}}
{{- if and $src (ne $src "") -}}
  {{- $title := "" -}}
  {{- with $p.Title }}{{ $title = . }}{{ end -}}
  {{- $alt := .Alt -}}
  {{- if not $alt -}}
    {{- $alt = printf "%s image" $title -}}
  {{- end -}}
  {{- $class := .Class | default "" -}}
  {{- $fetchPriority := .FetchPriority | default "auto" -}}
  {{- $loading := .Loading | default "lazy" -}}

  {{- $isRemote := false -}}
  {{- if or (hasPrefix $src "http://") (hasPrefix $src "https://") -}}
    {{- $isRemote = true -}}
  {{- end -}}

  {{- $final := $src -}}
  {{- if and (not $isRemote) (not (hasPrefix $src "/")) -}}
    {{- $final = printf "/%s" $src -}}
  {{- end -}}

  <img
    class="{{ $class }}"
    src="{{ $final | relURL }}"
    alt="{{ $alt | htmlEscape }}"
    loading="{{ $loading }}"
    decoding="async"
    fetchpriority="{{ $fetchPriority }}"
  />
{{- else -}}
  {{- /* Bundle processing only if no src provided */ -}}
  {{- $title := "" -}}
  {{- with $p.Title }}{{ $title = . }}{{ end -}}
  {{- $alt := .Alt -}}
  {{- if not $alt -}}
    {{- $alt = printf "%s image" $title -}}
  {{- end -}}
  {{- $class := .Class | default "" -}}
  {{- $sizes := .Sizes | default "100vw" -}}
  {{- $fetchPriority := .FetchPriority | default "auto" -}}
  {{- $loading := .Loading | default "lazy" -}}
  {{- $preload := .Preload | default false -}}
  {{- $widths := .Widths | default (slice 320 480 640 800 1024) -}}

{{- $isBundle := and (ne $p.BundleType "") (ne $p.BundleType nil) -}}
{{- if not $isBundle -}}
  {{- return -}}
{{- end -}}

{{- $imgs := $p.Resources.ByType "image" -}}
{{- if le (len $imgs) 0 -}}
  {{- return -}}
{{- end -}}

{{- $res := index $imgs 0 -}}

{{- $ext := lower $res.MediaType.SubType -}}
{{- if eq $ext "svg" -}}
  <img
    class="{{ $class }}"
    src="{{ $res.RelPermalink }}"
    alt="{{ $alt | htmlEscape }}"
    loading="{{ $loading }}"
    decoding="async"
    fetchpriority="{{ $fetchPriority }}"
  />
  {{- return -}}
{{- end -}}

{{- $avifSet := slice -}}
{{- $webpSet := slice -}}
{{- $origSet := slice -}}
{{- $maxWidth := 0 -}}

{{- range $widths -}}
  {{- $w := . -}}
  {{- if ge $res.Width $w -}}
    {{- $avif := $res.Resize (printf "%dx avif q60" $w) -}}
    {{- $webp := $res.Resize (printf "%dx webp q80" $w) -}}
    {{- $orig := $res.Resize (printf "%dx q80" $w) -}}
    {{- $avifSet = $avifSet | append (printf "%s %dw" $avif.RelPermalink $w) -}}
    {{- $webpSet = $webpSet | append (printf "%s %dw" $webp.RelPermalink $w) -}}
    {{- $origSet = $origSet | append (printf "%s %dw" $orig.RelPermalink $w) -}}
    {{- if gt $w $maxWidth }}{{ $maxWidth = $w }}{{ end -}}
  {{- end -}}
{{- end -}}

{{- $fallback := $res -}}
{{- if gt (len $origSet) 0 -}}
  {{- $fallback = $res.Resize (printf "%dx q80" $maxWidth) -}}
{{- end -}}

<picture>
  {{- if gt (len $avifSet) 0 }}
  <source
    type="image/avif"
    srcset='{{ delimit $avifSet "," }}'
    sizes="{{ $sizes }}"
  />
  {{- end }}
  {{- if gt (len $webpSet) 0 }}
  <source
    type="image/webp"
    srcset='{{ delimit $webpSet "," }}'
    sizes="{{ $sizes }}"
  />
  {{- end }}
  {{- if gt (len $origSet) 0 }}
  <source srcset='{{ delimit $origSet "," }}' sizes="{{ $sizes }}" />
  {{- end }}
  <img
    class="{{ $class }}"
    src="{{ $fallback.RelPermalink }}"
    alt="{{ $alt | htmlEscape }}"
    width="{{ $fallback.Width }}"
    height="{{ $fallback.Height }}"
    loading="{{ $loading }}"
    decoding="async"
    fetchpriority="{{ $fetchPriority }}"
  />
</picture>

  {{- if $preload }}
  <link
    rel="preload"
    as="image"
    href="{{ $fallback.RelPermalink }}"
    imagesrcset='{{ if gt (len $avifSet) 0 }}{{ delimit $avifSet "," }}{{ end }}'
    imagesizes="{{ $sizes }}"
  />
  {{- end -}}
{{- end -}}
