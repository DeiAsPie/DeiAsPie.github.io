<!doctype html>
<html lang="en" class="h-full">
    <head>
        {{ partial "head.html" . }}
    </head>

    <body
        class="min-h-full bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100"
    >
        <div class="mx-auto max-w-3xl px-4 sm:px-6 lg:max-w-6xl">
            {{ partial "header.html" . }}
            <main id="main" class="py-10">{{ block "main" . }}{{ end }}</main>
            {{ partial "footer.html" . }}
        </div>
        <script>
            // Initialize UI (theme toggle + mobile menu) in a robust way.
            // Add minimal console diagnostics so we can see whether the init runs in production.
            (function () {
                function initUI() {
                    try {
                        console.log("initUI: running", { readyState: document.readyState });
                    } catch (e) {}

                    // Theme toggle: sync aria-pressed; icons switch via CSS (dark: classes)
                    var btn = document.getElementById("theme-toggle");
                    if (btn) {
                        try {
                            console.log("initUI: found theme-toggle button");
                        } catch (e) {}

                        var mql = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
                        function getMode(){
                            var mode = 'auto';
                            try { mode = localStorage.getItem('themeMode') || 'auto'; } catch(e) {}
                            return mode;
                        }
                        function setMode(mode){
                            try { localStorage.setItem('themeMode', mode); } catch(e) {}
                            apply(mode);
                        }
                        function apply(mode){
                            var isDark = mode === 'dark' || (mode === 'auto' && mql && mql.matches);
                            document.documentElement.classList.toggle('dark', !!isDark);
                            document.documentElement.setAttribute('data-theme-mode', mode);
                            btn.title = 'Theme: ' + mode.charAt(0).toUpperCase() + mode.slice(1);
                            btn.setAttribute('aria-label', btn.title);
                            // For compatibility, reflect pressed only when explicitly dark
                            btn.setAttribute('aria-pressed', isDark ? 'true' : 'false');
                        }
                        function cycleMode(){
                            var mode = getMode();
                            var next = mode === 'auto' ? 'light' : (mode === 'light' ? 'dark' : 'auto');
                            setMode(next);
                            try { console.log('theme-toggle: mode ->', next); } catch(e) {}
                        }
                        if (mql && mql.addEventListener) {
                            mql.addEventListener('change', function(){
                                if (getMode() === 'auto') apply('auto');
                            });
                        }
                        apply(getMode());
                        btn.addEventListener('click', cycleMode);
                    } else {
                        try {
                            console.log("initUI: theme-toggle button not found");
                        } catch (e) {}
                    }

                    // Mobile menu toggle
                    var toggle = document.getElementById("mobile-menu-toggle");
                    var menu = document.getElementById("mobile-menu");
                    if (toggle && menu) {
                        try {
                            console.log("initUI: found mobile menu toggle and menu");
                        } catch (e) {}

                        toggle.addEventListener("click", function () {
                            try { console.log("mobile-toggle: click - before", { menuClass: menu.className, ariaExpanded: toggle.getAttribute("aria-expanded") }); } catch (e) {}
                            var isHidden = menu.classList.toggle("hidden");
                            toggle.setAttribute("aria-expanded", isHidden ? "false" : "true");
                            try { console.log("mobile-toggle: click - after", { menuClass: menu.className, ariaExpanded: toggle.getAttribute("aria-expanded") }); } catch (e) {}
                        });

                        // Ensure hamburger menu is properly hidden on resize to desktop
                        function handleResize() {
                            if (window.innerWidth >= 768) {
                                // md breakpoint
                                menu.classList.add("hidden");
                                toggle.setAttribute("aria-expanded", "false");
                            }
                        }
                        window.addEventListener("resize", handleResize);
                        handleResize(); // Call once on load
                    } else {
                        try {
                            console.log("initUI: mobile menu toggle or menu not found", { toggle: !!toggle, menu: !!menu });
                        } catch (e) {}
                    }

                    // Mark UI ready to allow theme transition effects after first paint
                    try { document.documentElement.classList.add("ui-ready"); } catch (e) {}
                }

                if (document.readyState === "loading") {
                    document.addEventListener("DOMContentLoaded", initUI);
                } else {
                    initUI();
                }
            })();
        </script>
        <script>
            // Prefetch nav targets on first intent (hover/focus)
            (function () {
                try {
                    var supports =
                        "relList" in HTMLLinkElement.prototype &&
                        HTMLLinkElement.prototype.relList.supports &&
                        HTMLLinkElement.prototype.relList.supports("prefetch");
                    if (!supports) return;
                } catch (e) {
                    return;
                }
                var seen = new Set();
                function add(href) {
                    if (
                        seen.has(href) ||
                        href.indexOf("#") > -1 ||
                        href.startsWith("mailto:")
                    )
                        return;
                    seen.add(href);
                    var l = document.createElement("link");
                    l.rel = "prefetch";
                    l.href = href;
                    l.as = "document";
                    document.head.appendChild(l);
                }
                function bind(a) {
                    var href = a.getAttribute("href");
                    if (!href || href.charAt(0) !== "/") return;
                    var h = function () {
                        add(href);
                    };
                    a.addEventListener("pointerenter", h, { once: true });
                    a.addEventListener("focus", h, { once: true });
                }
                document.querySelectorAll("nav a[href]").forEach(bind);
            })();
        </script>
    </body>
</html>
