{{ define "main" }}
<article>
  <header class="mb-8">
    <h1 class="text-3xl font-bold mb-2">{{ .Title }}</h1>
    {{/* Show back link only for recommendation pages; route courses to their hub */}}
    {{ $.Scratch.Set "back" "" }}
    {{ if eq .Section "recommendations" }}
    {{ if and .CurrentSection (eq .CurrentSection.RelPermalink "/recommendations/courses/") }}
    {{ $.Scratch.Set "back" ("/recommendations/courses/" | relURL) }}
    {{ else }}
    {{ $.Scratch.Set "back" ("/recommendations/" | relURL) }}
    {{ end }}
    {{ end }}
    {{ $back := $.Scratch.Get "back" }}
    {{ if $back }}
    <p class="mb-4"><a class="nav-link" href="{{ $back }}">‚Üê Back to all</a></p>
    {{ end }}
    {{ if .Params.link }}
    <a class="btn" href="{{ .Params.link }}" target="_blank" rel="noopener">Visit Website</a>
    {{ end }}
    <div class="mt-3 flex flex-wrap gap-2">
      {{ range .Params.categories }}<a
        class="text-xs bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 px-2 py-1 rounded"
  href="{{ (printf "/categories/%s/" (urlize .)) | relURL }}">{{ . }}</a>{{ end }}
      {{ range .Params.tags }}<a
        class="text-xs bg-slate-50 dark:bg-slate-900 text-slate-600 dark:text-slate-300 px-2 py-1 rounded border border-slate-200 dark:border-slate-800"
  href="{{ (printf "/tags/%s/" (urlize .)) | relURL }}">#{{ . }}</a>{{ end }}
    </div>
  </header>

  {{ $img := .Params.image }}
  {{ if $img }}
  {{ if or (hasPrefix $img "http://") (hasPrefix $img "https://") }}
  <img class="w-full max-h-72 object-contain mb-6" src="{{ $img }}" alt="{{ $.Title }} image" loading="lazy"
    decoding="async" />
  {{ else }}
  {{ $clean := strings.TrimPrefix "/" $img }}
  {{ $staticPath := printf "static/%s" $clean }}
  {{ if (fileExists $staticPath) }}
  <img class="w-full max-h-72 object-contain mb-6" src="{{ (printf "/%s" $clean) | relURL }}" alt="{{ $.Title }} image"
    loading="lazy" decoding="async" />
  {{ else }}
  {{/* If declared image missing, ignore and fall back to bundle resource */}}
  {{ $img = "" }}
  {{ end }}
  {{ end }}
  {{ end }}
  {{ if not $img }}
  {{ $resources := .Resources.ByType "image" }}
  {{ with index $resources 0 }}
  {{ $base := . }}
  {{ if ne (lower $base.MediaType.SubType) "svg" }}
  {{ $widths := slice 320 480 640 800 1024 }}
  {{ $webpSet := slice }}
  {{ $fallbackSet := slice }}
  {{ range $w := $widths }}
  {{ $webpVar := $base.Resize (printf "%dx webp q85" $w) }}
  {{ $origVar := $base.Resize (printf "%dx q85" $w) }}
  {{ $webpSet = $webpSet | append (printf "%s %dw" $webpVar.RelPermalink $w) }}
  {{ $fallbackSet = $fallbackSet | append (printf "%s %dw" $origVar.RelPermalink $w) }}
  {{ end }}
  {{ $largest := $base.Resize "1024x q85" }}
  <picture>
  <source type="image/webp" srcset="{{ delimit $webpSet ", " }}" sizes="(max-width: 900px) 100vw, 800px">
  <img class="w-full max-h-72 object-contain mb-6" src="{{ $largest.RelPermalink }}" srcset="{{ delimit $fallbackSet ", " }}" sizes="(max-width: 900px) 100vw, 800px" alt="{{ $.Title }} image" loading="lazy" decoding="async"
      fetchpriority="low" />
  </picture>
  {{ else }}
  <img class="w-full max-h-72 object-contain mb-6" src="{{ $base.RelPermalink }}" alt="{{ $.Title }} image"
    loading="lazy" decoding="async" />
  {{ end }}
  {{ end }}
  {{ end }}

  <div class="prose prose-slate dark:prose-invert max-w-none">
    {{ .Content }}
  </div>
</article>
{{ end }}